<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Alenstream — Embed HLS</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/plyr@3.7.8/dist/plyr.css" />
  <style>
    html, body {
      margin:0; padding:0; width:100%; height:100%;
      background:#000; overflow:hidden; font-family:sans-serif;
    }
    #videoContainer {
      position:fixed; top:0; left:0; width:100%; height:100%;
      background:#000; display:flex; align-items:center; justify-content:center;
    }
    video {
      width:100%; height:100vh; object-fit:contain; background:#000; border:0;
    }
    .plyr { width:100%!important; height:100%!important; max-width:100%!important; }
    .plyr__video-wrapper { height:100%!important; }

    /* Overlay tombol play */
    #overlayContainer {
      position:absolute; top:0; left:0; width:100%; height:100%;
      display:flex; align-items:center; justify-content:center; z-index:20;
      background:rgba(0,0,0,0.6);
    }
    #clickOverlay {
      width:90px; height:90px; background:#0d6efd; border-radius:50%;
      display:flex; align-items:center; justify-content:center;
      cursor:pointer; transition:0.3s;
      box-shadow:0 0 20px rgba(13,110,253,0.6); animation:pulse 1.5s infinite;
    }
    #clickOverlay:hover { background:#0b5ed7; transform:scale(1.1); }
    #clickOverlay svg { width:45px; height:45px; fill:white; }
    @keyframes pulse {0%{transform:scale(1);}50%{transform:scale(1.08);}100%{transform:scale(1);} }

    /* Spinner loading */
    #loadingOverlay {
      position:absolute; top:0; left:0; width:100%; height:100%;
      background:rgba(0,0,0,0.85);
      display:flex; align-items:center; justify-content:center;
      z-index:30; display:none;
    }
    .spinner {
      width:60px; height:60px;
      border:6px solid rgba(255,255,255,0.2);
      border-top-color:#0d6efd;
      border-radius:50%;
      animation:spin 1s linear infinite;
    }
    @keyframes spin { 0% {transform:rotate(0deg);} 100% {transform:rotate(360deg);} }
  </style>
</head>
<body>
  <div id="videoContainer">
    <video id="player" playsinline controls></video>

    <!-- Overlay play -->
    <div id="overlayContainer">
      <div id="clickOverlay">
        <svg viewBox="0 0 200 200">
          <polygon points="70,55 70,145 145,100" />
        </svg>
      </div>
    </div>

    <!-- Spinner -->
    <div id="loadingOverlay"><div class="spinner"></div></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/plyr@3.7.8/dist/plyr.polyfilled.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <script>
  (async () => {
    const token = location.pathname.split("/").pop();
    const res = await fetch("/api/videos/by-token/" + encodeURIComponent(token));
    if (!res.ok) { alert("❌ Video tidak ditemukan"); return; }

    const v = await res.json();
    const video = document.getElementById("player");
    const overlayContainer = document.getElementById("overlayContainer");
    const clickOverlay = document.getElementById("clickOverlay");
    const loadingOverlay = document.getElementById("loadingOverlay");

    const url = v.video_id; // full URL .m3u8 atau mp4
    const adLink = "https://example.com/directlink"; // ganti link iklanmu

    let clickCount = 0;
    let viewHit = false;
    let player;

    // Siapkan HLS
    if (Hls.isSupported()) {
      const hls = new Hls();
      hls.loadSource(url);
      hls.attachMedia(video);
    } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
      video.src = url;
    }

    clickOverlay.addEventListener("click", () => {
      clickCount++;
      if (clickCount === 1) {
        // Klik pertama → buka iklan
        openPopup(adLink);
      } else if (clickCount === 2) {
        // Klik kedua → mulai load video
        overlayContainer.style.display = "none";
        loadingOverlay.style.display = "flex";

        if (!player) {
          player = new Plyr(video, {
            controls: ['play','progress','current-time','mute','volume','fullscreen']
          });
        }
        player.play().catch(() => {});
      }
    });

    // Spinner off saat video siap
    video.addEventListener("canplay", () => { loadingOverlay.style.display = "none"; });
    video.addEventListener("playing", () => { loadingOverlay.style.display = "none"; });

    // Hit view hanya sekali
    video.addEventListener("playing", async () => {
      if (!viewHit) {
        viewHit = true;
        try { await fetch("/api/videos/" + v.id + "/view", { method:"POST" }); } catch {}
      }
    });

    function openPopup(url) {
      const a = document.createElement("a");
      a.href = url; a.target = "_blank"; a.rel = "noopener noreferrer";
      document.body.appendChild(a); a.click(); a.remove();
    }
  })();
  </script>
</body>
</html>
